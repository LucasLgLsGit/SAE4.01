{% extends '_template/base.html.twig' %}

{% block css %}
	<link rel="stylesheet" href="/assets/css/usersAdmin.css">
{% endblock %}

{% block body %}
<div class="users-container">
	<div class="container mt-5">
		<h2 class="mb-4">Gestion des Utilisateurs</h2>
		<table class="table table-striped">
			<thead>
				<tr>
					<th>ID</th>
					<th>Nom</th>
					<th>Prénom</th>
					<th>Email</th>
					<th>Admin</th>
					<th>Adhérent</th>
					<th>Actions</th>
				</tr>
			</thead>
			<tbody>
				{% for user in users %}
				<tr>
					<td>{{ user.getId() }}</td>
					<td>{{ user.getNom() }}</td>
					<td>{{ user.getPrenom() }}</td>
					<td>{{ user.getMail() }}</td>
					<td>
						<input type="checkbox" class="toggle-perm" data-user-id="{{ user.getId() }}" data-perm="admin" {% if user.isAdmin() %}checked{% endif %}>
					</td>
					<td>
						<input type="checkbox" class="toggle-perm" data-user-id="{{ user.getId() }}" data-perm="adherent" {% if user.isAdherent() %}checked{% endif %}>
					</td>
					<td>
						<a href="#" class="btn btn-primary btn-sm"><i class="bi bi-pencil-square"></i></a>
						<button class="btn btn-danger btn-sm delete-user" data-user-id="{{ user.getId() }}"><i class="bi bi-trash"></i></button>
					</td>
				</tr>
				{% endfor %}
			</tbody>
		</table>
	</div>
</div>

<div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel" aria-hidden="true">
  <div class="modal-dialog">
	<div class="modal-content">
	  <div class="modal-header">
		<h5 class="modal-title" id="deleteUserModalLabel">Confirmer la suppression</h5>
		<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
	  </div>
	  <div class="modal-body">
		Êtes-vous sûr de vouloir supprimer cet utilisateur ?
	  </div>
	  <div class="modal-footer">
		<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
		<button type="button" class="btn btn-danger" id="confirmDeleteButton">Supprimer</button>
	  </div>
	</div>
  </div>
</div>
{% endblock %}

{% block javascript %}
<script>
  document.addEventListener('DOMContentLoaded', function () {
	const deleteButtons = document.querySelectorAll('.delete-user');
	const confirmDeleteButton = document.getElementById('confirmDeleteButton');
	let userIdToDelete = null;

	deleteButtons.forEach(button => {
	  button.addEventListener('click', function (event) {
		event.preventDefault();
		userIdToDelete = this.getAttribute('data-user-id');
		const deleteUserModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
		deleteUserModal.show();
	  });
	});

	confirmDeleteButton.addEventListener('click', function () {
	  if (userIdToDelete) {
		fetch('/user_delete.php', {
		  method: 'POST',
		  headers: {
			'Content-Type': 'application/x-www-form-urlencoded',
		  },
		  body: `id_user=${userIdToDelete}`,
		})
		.then(response => {
		  if (!response.ok) {
			throw new Error('Erreur réseau');
		  }
		  return response.json();
		})
		.then(data => {
		  if (data.success) {
			location.reload();
		  } else {
			console.error(data.message || 'Une erreur est survenue.');
		  }
		})
		.catch(error => {
		  console.error('Erreur:', error);
		});
	  }
	});
  });
</script>
{% endblock %}